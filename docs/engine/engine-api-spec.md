# @caisogames/ai-engine — Engine API Specification

> **Source of Truth** for all code generated by AI agents.
> Code Generator Agent는 이 문서에 정의된 API 외의 것을 사용해선 안 됩니다.

**문서 버전:** 1.0  
**최종 업데이트:** 2026-02-27  
**대상:** Code Generator Agent, Engineering Team, Claude Code Integration

---

## 목차

1. [Engine 초기화](#1-engine-초기화)
2. [Entity 시스템](#2-entity-시스템)
3. [내장 Components](#3-내장-components)
4. [내장 Systems](#4-내장-systems)
5. [Scene 관리](#5-scene-관리)
6. [Asset 로더](#6-asset-로더)
7. [Input Manager](#7-input-manager)
8. [이벤트/파티클/카메라 API](#8-이벤트파티클카메라-api)
9. [오디오 API](#9-오디오-api)
10. [에이전트 코드 생성 패턴 (필독)](#10-에이전트-코드-생성-패턴-필독)
11. [금지 패턴](#11-금지-패턴)

---

## 1. Engine 초기화

```typescript
import { Engine, EngineConfig } from '@caisogames/ai-engine';

const config: EngineConfig = {
  canvas: '#game-canvas',      // CSS selector or HTMLCanvasElement
  width: 800,                  // 논리적 해상도 (비율 유지 자동 스케일)
  height: 600,
  targetFPS: 60,
  backgroundColor: '#1a1a2e',
  gravity: 980,                // px/s² (0이면 중력 비활성화)
  debug: false,                // 충돌 박스, FPS 표시 등
};

await Engine.init(config);
Engine.start();               // Game Loop 시작
```

---

## 2. Entity 시스템

```typescript
// 엔티티 생성
const entity = Engine.createEntity(id: string): Entity;

// 엔티티 조회
const entity = Engine.getEntity(id: string): Entity | null;
const entities = Engine.getEntitiesByTag(tag: string): Entity[];

// 엔티티 제거
Engine.destroyEntity(id: string): void;

// 컴포넌트 조작 (엔티티 메서드)
entity.addComponent<T>(ComponentClass: ComponentType<T>, config: Partial<T>): void;
entity.getComponent<T>(ComponentClass: ComponentType<T>): T | null;
entity.removeComponent<T>(ComponentClass: ComponentType<T>): void;
entity.hasComponent<T>(ComponentClass: ComponentType<T>): boolean;

// 태그
entity.addTag(tag: string): void;
entity.removeTag(tag: string): void;
entity.hasTag(tag: string): boolean;
```

---

## 3. 내장 Components

> 에이전트는 이 목록 외의 커스텀 컴포넌트를 만들어선 **안 됩니다**.
> 필요한 컴포넌트가 없으면 Engineering Lead에게 엔진 확장을 요청하세요.

### 3.1 Transform
```typescript
interface TransformConfig {
  position: { x: number; y: number };  // 픽셀 단위
  scale?: { x: number; y: number };    // 기본값: { x: 1, y: 1 }
  rotation?: number;                    // 라디안, 기본값: 0
  zIndex?: number;                      // 렌더링 순서, 기본값: 0
}
```

### 3.2 Sprite
```typescript
interface SpriteConfig {
  texture: string;              // Asset 키 (AssetLoader로 미리 로드 필요)
  width?: number;               // 기본값: 텍스처 원본 크기
  height?: number;
  opacity?: number;             // 0.0 ~ 1.0, 기본값: 1.0
  flipX?: boolean;              // 좌우 반전
  flipY?: boolean;
  tint?: string;                // 색상 오버레이 (hex), 기본값: 없음
  animations?: {
    [animationName: string]: {
      frames: number[];         // 스프라이트 시트 인덱스
      fps: number;
      loop?: boolean;           // 기본값: true
    };
  };
  defaultAnimation?: string;
}

// 애니메이션 제어 (런타임)
entity.getComponent(Component.Sprite).play(animationName: string): void;
entity.getComponent(Component.Sprite).stop(): void;
entity.getComponent(Component.Sprite).setFrame(frameIndex: number): void;
```

### 3.3 Physics
```typescript
interface PhysicsConfig {
  velocity?: { x: number; y: number };  // 기본값: { x: 0, y: 0 }
  gravity?: number;                      // 이 엔티티의 중력 (Engine 전역값 override)
  friction?: number;                     // 수평 마찰 계수 0~1, 기본값: 0.9
  mass?: number;                         // 기본값: 1
  isStatic?: boolean;                    // true면 물리 계산 제외 (플랫폼 등)
  collider: {
    type: 'box' | 'circle';
    width?: number;   // box用
    height?: number;  // box用
    radius?: number;  // circle用
    offsetX?: number; // 엔티티 중심으로부터 오프셋
    offsetY?: number;
  };
  isTrigger?: boolean;  // true면 충돌 감지만 하고 물리 반응 없음
}
```

### 3.4 PlayerController
```typescript
interface PlayerControllerConfig {
  moveSpeed: number;          // px/s
  jumpForce: number;          // 초기 점프 속도 (px/s, 양수)
  maxJumps?: number;          // 점프 가능 횟수, 기본값: 1 (2=더블점프)
  coyoteTime?: number;        // 코요테 타임 (ms), 기본값: 120
  jumpBufferTime?: number;    // 점프 버퍼 (ms), 기본값: 100
  dashSpeed?: number;         // 대쉬 속도 (px/s), 없으면 대쉬 비활성화
  dashDuration?: number;      // 대쉬 지속 시간 (ms)
  dashCooldown?: number;      // 대쉬 쿨타임 (ms)
  canWallSlide?: boolean;     // 기본값: false
}
```

### 3.5 Enemy
```typescript
interface EnemyConfig {
  health: number;
  moveSpeed?: number;         // 기본값: 80
  damage?: number;            // 플레이어 접촉 시 데미지, 기본값: 1
  behavior: 'patrol' | 'chase' | 'stationary' | 'shoot';
  patrolRange?: number;       // 'patrol' 타입: 왕복 거리 (px)
  chaseRange?: number;        // 'chase' 타입: 플레이어 감지 거리 (px)
  shootInterval?: number;     // 'shoot' 타입: 발사 주기 (ms)
  dropItems?: string[];       // 처치 시 드랍 아이템 ID 목록
}
```

### 3.6 Collectible
```typescript
interface CollectibleConfig {
  type: 'coin' | 'gem' | 'powerup' | 'key';
  value?: number;             // 점수/재화 값, 기본값: 1
  effect?: {                  // powerup 타입에만 적용
    type: 'heal' | 'speed_boost' | 'invincibility' | 'extra_jump';
    duration?: number;        // ms, 기본값: 5000
    magnitude?: number;       // 배율 (1.5 = 50% 증가)
  };
  magnetRange?: number;       // 플레이어 자동 흡착 범위 (px), 기본값: 0
}
```

### 3.7 Trigger
```typescript
interface TriggerConfig {
  width: number;
  height: number;
  onEnter?: string;   // 발생시킬 게임 이벤트 이름 (Engine.Events.emit 연동)
  onExit?: string;
  once?: boolean;     // true면 1회만 발동, 기본값: false
  tag?: string;       // 특정 태그의 엔티티만 감지
}
```

### 3.8 Camera
```typescript
// Camera는 엔티티에 컴포넌트로 추가하는 게 아니라 Engine.Camera API로 제어
// (아래 섹션 8 참조)
```

---

## 4. 내장 Systems

시스템은 Engine이 자동으로 처리합니다. **에이전트가 직접 System을 호출하는 코드를 작성할 필요 없습니다.**

| 시스템 | 역할 | 자동 처리 조건 |
|--------|------|----------------|
| `MovementSystem` | PlayerController에 따른 이동 | `PlayerController` 컴포넌트가 있는 엔티티 |
| `PhysicsSystem` | 중력, 속도, 위치 업데이트 | `Physics` 컴포넌트가 있는 엔티티 |
| `CollisionSystem` | 충돌 감지 및 반응 | `Physics` 컴포넌트가 있는 엔티티 |
| `RenderSystem` | Canvas 렌더링 | `Transform` + `Sprite` 컴포넌트 |
| `AnimationSystem` | 스프라이트 애니메이션 재생 | `Sprite`에 `animations` 정의된 엔티티 |
| `AudioSystem` | 사운드 재생 큐 처리 | `Engine.Audio.play()` 호출 시 |

---

## 5. Scene 관리

```typescript
import { Scene } from '@caisogames/ai-engine';

// Scene 정의
class GameScene extends Scene {
  async onLoad(): Promise<void> {
    // 에셋 로드, 엔티티 생성 등 초기화
    await Engine.Assets.load([...]);
    this.createPlayer();
    this.createLevel();
  }

  onUpdate(deltaTime: number): void {
    // 매 프레임 호출 (60fps = deltaTime ≈ 16.67ms)
    // 커스텀 게임 로직만 여기에
  }

  onDestroy(): void {
    // 씬 전환 시 정리
  }

  private createPlayer(): void {
    const player = Engine.createEntity('player');
    // ... 컴포넌트 추가
  }
}

// Scene 등록 및 전환
Engine.Scenes.register('game', GameScene);
Engine.Scenes.register('menu', MenuScene);
Engine.Scenes.register('gameover', GameOverScene);

Engine.Scenes.load('menu');                          // 즉시 전환
Engine.Scenes.loadWithTransition('game', 'fade', 500); // 페이드 전환 (ms)
```

---

## 6. Asset 로더

```typescript
// 게임 시작 전 또는 Scene.onLoad()에서 로드
await Engine.Assets.load([
  { key: 'player',     type: 'image',  src: 'assets/sprites/player.png' },
  { key: 'player_anim',type: 'spritesheet', src: 'assets/sprites/player_sheet.png',
    frameWidth: 64, frameHeight: 64 },
  { key: 'bg_forest',  type: 'image',  src: 'assets/backgrounds/forest.png' },
  { key: 'jump_sfx',   type: 'audio',  src: 'assets/audio/jump.wav' },
  { key: 'bgm_level1', type: 'audio',  src: 'assets/audio/bgm_level1.mp3' },
  { key: 'level1',     type: 'json',   src: 'assets/levels/level1.json' },
]);

// 로드 진행 상태
Engine.Assets.onProgress((loaded, total) => {
  console.log(`${loaded}/${total} assets loaded`);
});
```

---

## 7. Input Manager

```typescript
// 키보드
Engine.Input.isKeyDown('ArrowLeft'): boolean;
Engine.Input.isKeyDown('Space'): boolean;
Engine.Input.isKeyJustPressed('Space'): boolean;  // 이번 프레임에 처음 눌림
Engine.Input.isKeyJustReleased('Space'): boolean;

// 마우스
Engine.Input.mouse.x: number;
Engine.Input.mouse.y: number;
Engine.Input.mouse.isDown: boolean;
Engine.Input.mouse.isJustClicked: boolean;

// 모바일 터치 (가상 D-Pad)
Engine.Input.touch.left: boolean;
Engine.Input.touch.right: boolean;
Engine.Input.touch.jump: boolean;
Engine.Input.touch.action: boolean;

// Virtual D-Pad UI 활성화 (모바일 감지 시 자동 표시 옵션)
Engine.Input.enableVirtualDpad({
  position: 'bottom-left',
  jumpButton: 'bottom-right',
});
```

---

## 8. 이벤트/파티클/카메라 API

### 8.1 게임 이벤트
```typescript
// 이벤트 발행/구독 (Agent 간 커플링 제거용)
Engine.Events.emit('player_died', { x: 100, y: 200 });
Engine.Events.on('player_died', (data) => { /* ... */ });
Engine.Events.once('level_complete', callback);
Engine.Events.off('player_died', callback);
```

### 8.2 파티클 이펙트
```typescript
// 내장 파티클 프리셋 (Code Generator Agent가 조합해서 사용)
Engine.Particle.emit(preset: string, config: ParticleConfig): void;

// 사용 가능한 내장 프리셋
type ParticlePreset =
  | 'jump_dust'       // 점프 시 먼지
  | 'land_impact'     // 착지 임팩트
  | 'coin_collect'    // 코인 수집
  | 'enemy_death'     // 적 처치
  | 'damage_spark'    // 데미지 스파크
  | 'speed_trail'     // 대쉬 잔상
  | 'sparkle';        // 빛나는 이펙트

interface ParticleConfig {
  x: number;
  y: number;
  count?: number;       // 파티클 수, 기본값: 프리셋별 기본값
  scale?: number;       // 크기 배율, 기본값: 1.0
  color?: string;       // hex, 기본값: 프리셋 색상
  duration?: number;    // ms, 기본값: 프리셋별 기본값
}
```

### 8.3 카메라
```typescript
// 카메라 팔로우
Engine.Camera.follow(entityId: string, config?: {
  offsetX?: number;        // 기본값: 0
  offsetY?: number;        // 기본값: -50 (캐릭터보다 약간 위)
  lerpX?: number;          // 추적 부드러움 0~1 (1=즉각, 0.08=부드럽게)
  lerpY?: number;
  deadZoneX?: number;      // 움직이지 않는 중앙 데드존 (px)
  deadZoneY?: number;
  clampToBounds?: {        // 레벨 경계 밖으로 나가지 않도록
    minX: number; maxX: number;
    minY: number; maxY: number;
  };
}): void;

// 카메라 이펙트
Engine.Camera.shake(config: {
  intensity: number;       // 픽셀 단위 진폭
  duration: number;        // ms
  decay?: boolean;         // true면 시간에 따라 강도 감소, 기본값: true
}): void;

Engine.Camera.flash(config: {
  color?: string;          // 기본값: '#ffffff'
  duration?: number;       // ms, 기본값: 200
}): void;

// 카메라 이동
Engine.Camera.panTo(x: number, y: number, duration: number): Promise<void>;
```

---

## 9. 오디오 API

```typescript
// SFX 재생
Engine.Audio.play(key: string, options?: {
  volume?: number;     // 0.0~1.0, 기본값: 1.0
  pitch?: number;      // 배율, 기본값: 1.0 (랜덤화: { min: 0.9, max: 1.1 })
  loop?: boolean;      // 기본값: false
}): void;

// BGM 관리
Engine.Audio.playBgm(key: string, options?: {
  volume?: number;
  fadeInDuration?: number;  // ms
  loop?: boolean;           // 기본값: true
}): void;

Engine.Audio.stopBgm(fadeOutDuration?: number): void;

// 전역 볼륨
Engine.Audio.setMasterVolume(volume: number): void;  // 0~1
Engine.Audio.setSfxVolume(volume: number): void;
Engine.Audio.setBgmVolume(volume: number): void;
```

---

## 10. 에이전트 코드 생성 패턴 (필독)

Code Generator Agent는 반드시 아래 패턴을 따라야 합니다.

### ✅ 올바른 패턴 예시: 플레이어 생성

```typescript
import { Engine, Component, Scene } from '@caisogames/ai-engine';

class GameScene extends Scene {
  async onLoad(): Promise<void> {
    // 1. 에셋 로드
    await Engine.Assets.load([
      { key: 'player_sheet', type: 'spritesheet', src: 'assets/sprites/player.png',
        frameWidth: 64, frameHeight: 64 },
      { key: 'jump_sfx', type: 'audio', src: 'assets/audio/jump.wav' },
    ]);

    // 2. 플레이어 생성
    const player = Engine.createEntity('player');
    player.addTag('player');

    player.addComponent(Component.Transform, {
      position: { x: 100, y: 500 },
    });

    player.addComponent(Component.Sprite, {
      texture: 'player_sheet',
      width: 64, height: 64,
      animations: {
        idle: { frames: [0, 1, 2, 3], fps: 8 },
        walk: { frames: [4, 5, 6, 7], fps: 12 },
        jump: { frames: [8, 9], fps: 10, loop: false },
      },
      defaultAnimation: 'idle',
    });

    player.addComponent(Component.Physics, {
      collider: { type: 'box', width: 48, height: 60 },
      gravity: 980,
    });

    player.addComponent(Component.PlayerController, {
      moveSpeed: 200,
      jumpForce: 420,
      maxJumps: 2,
      coyoteTime: 120,
    });

    // 3. 카메라 설정
    Engine.Camera.follow('player', {
      lerpX: 0.1, lerpY: 0.12,
      offsetY: -40,
      clampToBounds: { minX: 0, maxX: 3000, minY: 0, maxY: 1200 },
    });

    // 4. 이벤트 연결
    Engine.Events.on('player_jump', (data) => {
      Engine.Audio.play('jump_sfx', { pitch: { min: 0.95, max: 1.05 } });
      Engine.Particle.emit('jump_dust', { x: data.x, y: data.y });
    });
  }
}
```

### ✅ 올바른 패턴 예시: 플랫폼 및 적 생성

```typescript
// 플랫폼 (정적 물체)
const platform = Engine.createEntity('platform_1');
platform.addComponent(Component.Transform, { position: { x: 300, y: 450 } });
platform.addComponent(Component.Sprite, { texture: 'platform_tile', width: 200, height: 32 });
platform.addComponent(Component.Physics, {
  isStatic: true,
  collider: { type: 'box', width: 200, height: 32 },
});

// 순찰 적
const slime = Engine.createEntity('enemy_slime_1');
slime.addComponent(Component.Transform, { position: { x: 600, y: 450 } });
slime.addComponent(Component.Sprite, { texture: 'slime', width: 48, height: 40 });
slime.addComponent(Component.Physics, {
  collider: { type: 'box', width: 40, height: 36 },
});
slime.addComponent(Component.Enemy, {
  health: 2,
  damage: 1,
  behavior: 'patrol',
  patrolRange: 150,
  moveSpeed: 60,
});
```

---

## 11. 금지 패턴

Code Generator Agent는 아래 코드를 **절대 생성하면 안 됩니다**.

```typescript
// ❌ 금지: Engine 내부 직접 접근
import { PhysicsSystem } from '@caisogames/ai-engine/src/systems/physics'; // 내부 모듈

// ❌ 금지: 커스텀 컴포넌트 클래스 선언 (없는 컴포넌트가 필요하면 SR 제출)
class HealthComponent { ... }

// ❌ 금지: 직접 Canvas 접근
const canvas = document.getElementById('game-canvas') as HTMLCanvasElement;
const ctx = canvas.getContext('2d');
ctx.drawImage(...);  // Engine.RenderSystem을 우회

// ❌ 금지: 직접 requestAnimationFrame
requestAnimationFrame(() => { ... });  // Engine.start()가 이미 관리

// ❌ 금지: 전역 상태 직접 수정
window.playerHealth = 3;  // Engine.Events로 상태 공유할 것

// ❌ 금지: eval() 또는 Function() 생성자
eval(someCode);
new Function(someCode)();
```

---

**관련 문서:**
- [Design Document](../design_document.md)
- [Agent Requirements Specification](../specifications/agent-requirements.md)
- [Claude Code Integration Guide](../guides/claude-code-integration.md)
